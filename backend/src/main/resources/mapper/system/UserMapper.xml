<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.oasystem.modules.system.mapper.UserMapper">

    <resultMap id="UserResultMap" type="com.oasystem.modules.system.entity.User">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="password" column="password"/>
        <result property="realName" column="real_name"/>
        <result property="avatar" column="avatar"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="gender" column="gender"/>
        <result property="deptId" column="dept_id"/>
        <result property="positionId" column="position_id"/>
        <result property="status" column="status"/>
        <result property="lastLoginTime" column="last_login_time"/>
        <result property="lastLoginIp" column="last_login_ip"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="deleted" column="deleted"/>
        <result property="roleId" column="role_id"/>
        <result property="roleName" column="role_name"/>
        <result property="roleCode" column="role_code"/>
        <result property="deptName" column="dept_name"/>
        <result property="positionName" column="position_name"/>
    </resultMap>

    <!-- 根据用户名查询用户 -->
    <select id="selectByUsername" resultMap="UserResultMap">
        SELECT u.*,
               r.id as role_id,
               r.role_name,
               r.role_code,
               d.dept_name,
               p.position_name
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id
        LEFT JOIN org_department d ON u.dept_id = d.id
        LEFT JOIN org_position p ON u.position_id = p.id
        WHERE u.username = #{username}
          AND u.deleted = 0
        LIMIT 1
    </select>

    <!-- 分页查询用户列表 -->
    <select id="selectUserPage" resultMap="UserResultMap">
        SELECT u.*,
               r.id as role_id,
               r.role_name,
               r.role_code,
               d.dept_name,
               p.position_name
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id
        LEFT JOIN org_department d ON u.dept_id = d.id
        LEFT JOIN org_position p ON u.position_id = p.id
        WHERE u.deleted = 0
        <if test="username != null and username != ''">
            AND u.username LIKE CONCAT('%', #{username}, '%')
        </if>
        <if test="realName != null and realName != ''">
            AND u.real_name LIKE CONCAT('%', #{realName}, '%')
        </if>
        <if test="phone != null and phone != ''">
            AND u.phone LIKE CONCAT('%', #{phone}, '%')
        </if>
        <if test="status != null">
            AND u.status = #{status}
        </if>
        <if test="deptId != null">
            AND u.dept_id = #{deptId}
        </if>
        ORDER BY u.create_time DESC
    </select>

    <!-- 根据ID查询用户详情 -->
    <select id="selectUserById" resultMap="UserResultMap">
        SELECT u.*,
               r.id as role_id,
               r.role_name,
               r.role_code,
               d.dept_name,
               p.position_name
        FROM sys_user u
        LEFT JOIN sys_user_role ur ON u.id = ur.user_id
        LEFT JOIN sys_role r ON ur.role_id = r.id
        LEFT JOIN org_department d ON u.dept_id = d.id
        LEFT JOIN org_position p ON u.position_id = p.id
        WHERE u.id = #{id}
          AND u.deleted = 0
    </select>

</mapper>
